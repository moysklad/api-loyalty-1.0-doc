# МойСклад LoyaltyAPI

LoyaltyAPI МоегоСклада дает возможность разработчикам обмениваться с внешними программами лояльности следующей информацией:

- Информация о покупателях и их балансе баллов лояльности
- Продажа и расчёт её скидки
- Возвраты

Подключение внешней программы лояльности в сервисе МойСклад происходит через решение, которое необходимо разработать и опубликовать в нашем каталоге решений. Для этого вам нужно:

1. Получить доступ к [Личному кабинету разработчика](https://dev.moysklad.ru/doc/api/vendor/1.0/#lichnyj-kabinet-razrabotchika).
2. Создать черновик [серверного решения](https://dev.moysklad.ru/doc/api/vendor/1.0/#serwernye-resheniq) с указанием блока `<loyaltyApi/>` в дескрипторе.
3. Используя эту документацию создать бизнес-логику работы с системой лояльности на сервере.
4. Протестировать и отправить решение на публикацию.

## Сценарий работы
 
Предварительные условия:

- Пользователь на стороне МоегоСклада устанавливает решение.
- Разработчик в ответ на запрос [активации решения на аккаунте](https://dev.moysklad.ru/doc/api/vendor/1.0/#aktiwaciq-resheniq-na-akkaunte) возвращает статус `SettingsRequired`.
- Разработчик через [JSON API](https://dev.moysklad.ru/doc/api/remap/1.2) запрашивает всю необходимую информацию для настройки скидок (информация о покупателях, товарах, магазинах и т.д.).
- Пользователь на стороне МоегоСклада открывает окно настроек решения, при этом МойСклад отображает [iframe](https://dev.moysklad.ru/doc/api/vendor/1.0/#glawnyj-iframe) с адресом, указанным Разработчиком в дескрипторе решения.
- Пользователь в iframe регистрируется на сайте разработчика или указывает полученные ранее данные для доступа.
- Разработчик передает данные для доступа к системе лояльности: __базовый адрес системы лояльности__ (в приведенных примерах обозначен как example.com/baseurl) и __ключ доступа__ через [эндпоинт на стороне МоегоСклада](https://dev.moysklad.ru/doc/api/vendor/1.0/#izmenenie-nastroek-loql-nosti-na-akkaunte). При этом может быть указан способ поиска покупателей: внутренний (в МоемСкладе) или внешний (в системе лояльности).
- Пользователь на [странице настроек Скидок](https://online.moysklad.ru/app/#discount) в МоемСкладе активирует программу лояльности, связанную с решением.

После всех настроек МойСклад может отправлять во внешнюю систему лояльности следующие запросы:

- Создание покупателя
- Поиск покупателя
- Запрос баланса баллов покупателя
- Расчет скидок для продажи
- Создание продажи
- Создание возврата

Запросы осуществляются на определенный эндпоинт относительно базового адреса. Каждый из запросов содержит в своем составе ключ доступа.

## Обработка ошибок
Если возникла ошибка при обработке запроса, то она должна приходить с HTTP кодом, отличным от 200, 201 и 204

### Структура ошибок
Ошибки представляют собой массив **errors**, содержащий объекты **error**, каждый из которых описывает отдельную ошибку.

### Структура объекта error
+ **error** `string` - Заголовок ошибки `Необходимое`
+ **parameter** `string` - Параметр, на котором произошла ошибка
+ **code** `integer` - Код ошибки `Необходимое`
+ **error_message** `string` - Сообщение, прилагаемое к ошибке. `Необходимое`

> **Response**  
> 412 (application/json)

```json
{
  "errors": [
    {
      "error": "Не указан обязательный параметр",
      "parameter": "phone",
      "code": 999,
      "error_message": "Требуется указать номер телефона"
    }
  ]
}
```
