# МойСклад FiscalAPI

Мы предлагаем инструмент, который помогает проводить фискализацию продаж.<br/> 
Он связывает Кассу МойСклад с внешними фискальными сервисами.<br/>
В основе решения — публичное АПИ для фискализации, с помощью которого МойСклад будет передавать операции на фискализацию в стороннее решение.

## Что нужно сделать, чтобы поддержать интеграцию

Подключение внешнего сервиса фискализации продаж в сервисе МойСклад происходит через решение, которое необходимо разработать и опубликовать в нашем каталоге решений. Для этого вам нужно:

- Получить доступ к [Личному кабинету разработчика](https://dev.moysklad.ru/doc/api/vendor/1.0/#lichnyj-kabinet-razrabotchika)
- Создать черновик [серверного решения](https://dev.moysklad.ru/doc/api/vendor/1.0/#serwernye-resheniq)
- При создании приложения использовать [VendorAPI](https://dev.moysklad.ru/doc/api/vendor/1.0/#bystryj-start).
В [дескрипторе](https://dev.moysklad.ru/doc/api/vendor/1.0/#deskriptor-resheniq) приложения, в блоке `<fiscalApi>`, указать:
   - `endpointBase` - базовый URL на стороне разработчика с имплементацией АПИ
   - `operationTypes` - какие операции будет фискализировать решение. Например, к операциям, подлежащим фискализации, относятся продажа и возврат и не относится внесение денег. Следовательно, необходимо указать только продажу и возврат как операции для фискализации. Внесение денег не будет отправляться на фискализацию
   - `paymentTypes` - список доступных способов оплаты, чтобы ограничить способ оплаты на кассе. Например, не принимается оплата по qr-коду

> Пример дескриптора

```xml
<ServerApplication xmlns="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2
      https://apps-api.moysklad.ru/xml/ns/appstore/app/v2/application-v2.xsd">
    <vendorApi>
        <endpointBase>https://example.com/dummy-app</endpointBase>
    </vendorApi>

    <fiscalApi>
        <endpointBase>https://vendor.com/api/fiscal</endpointBase>
        <operationTypes>
            <retailDemand/>
        </operationTypes>
        <paymentTypes>
            <cash/>
            <card/>
            <cashCard/>
        </paymentTypes>
    </fiscalApi>

    <access>
        <resource>https://online.moysklad.ru/api/remap/1.2</resource>
        <scope>admin</scope>
    </access>
</ServerApplication>
```

- Поддержать API: используя эту документацию, создать бизнес-логику работы с системой лояльности на сервере
   - Уметь принимать операции на фискализацию и возвращать статус фискализации и чек
- Создать Точку продаж и в разделе "Кассовые чеки" выбрать следующие значения:
   - Формирование чеков — “Облачное”
   - Касса для формирования облачных чеков — “Решение для обработки чеков”
   - В выпадающем списке выбрать свое решение
- Установить приложение Кассы
- Протестировать и отправить решение на публикацию

## Верификация запросов на фискализацию
При установке решения пользователем внутри МоегоСклада генерируется пара RSA-ключей.
Все запросы на фискализацию подписываются приватным RSA-ключом. С помощью публичного ключа можно верифицировать запрос.

Так же при установке решения генерируется `fiscalId` - идентификатор регистрации пары "аккаунт-решение" в МоемСкладе.

Публичный ключ и идентификатор "аккаунт-решение" передаются удаленному сервису фискализации через [VendorApi](https://dev.moysklad.ru/doc/api/vendor/1.0/#aktiwaciq-resheniq-na-akkaunte) в блоке `additional`.

> Ключ и идентификатор "аккаунт-решение" внутри запроса VendorApi на установку решения:

```json
{
  "additional": {
    "galyaApi": {
      "publicKey": "MIIBIjANBgkqhkiG9w0BAQEFAA...",
      "galyaId": "f5080160-acc6-4241-b8d3-6c5f9731fe5e"
    }
  }
}
```

## Сценарий работы

1. Пользователь устанавливает решение для фискализации из каталога решений МоегоСклада
2. Пользователь указывает, для какой точки продаж установлено приложение фискализации
3. Пользователь устанавливает кассу, синхронизирует настройки
4. Пользователь создаёт операцию. Например, проводит продажу
5. Операция передается в выбранное решение для фискализации
6. Решение выполняет фискализацию и другие манипуляции с чеком, затем возвращает МоемуСкладу чек (файл в формате PDF, сжатый в zip-архив; этот архив передается закодированным в base64 строку)
7. Касса печатает чек

## Поддерживаемые операции

После установки решения и настройки точки продаж пользователем, МойСклад может отправлять к удаленному сервису фискализации следующие запросы:

- Открытие смены
- Создание продажи
- Возврат продажи
- Внесение денежных средств в кассу
- Выплата денежных средств из кассы
- Закрытие смены

Запросы осуществляются на определенный эндпоинт относительно базового адреса. Каждый из запросов содержит в заголовках идентификатор "аккаунт-решение".

## Обработка ошибок
Если возникла ошибка при обработке запроса, она должна приходить с HTTP кодом, отличным от 200, 201 и 204

### Структура ошибок
Ошибки представляют собой массив **errors**, содержащий объекты **error**, каждый из которых описывает отдельную ошибку.

### Структура объекта error
+ **error** `string` - Заголовок ошибки `Необходимое`
+ **parameter** `string` - Параметр, на котором произошла ошибка
+ **code** `integer` - Код ошибки `Необходимое`
+ **error_message** `string` - Сообщение, прилагаемое к ошибке. `Необходимое`

> **Response**  
> 412 (application/json)

```json
{
  "errors": [
    {
      "error": "Неправильный или просроченный ключ доступа",
      "code": 12017,
      "error_message": "Измените данные в приложении"
    }
  ]
}
```
